var reviewsImageAndSharing={};function clearReviewfilters(e,t,a){var r=$(e),i=$("#product-review-page-container").data("shop").toLowerCase();r.on("change",function(){var e=$("#review-sorter #rw-sort-by").val(),t=$("#review-filter #rw-filter-by").val();queryAndRenderReviews(a+"get-reviews?shop="+i+"&rwsortby="+e+"&rwfilterby="+t+"&page=1","#rw-product-page-template",!0),$("#rw-page").val(2)})}function getQueryParam(e){var t;return window.location.search.substr(1).split("&").forEach(function(a){e==a.split("=")[0]&&(t=a.split("=")[1])}),t}function insertParamAndResetPage(e,t){e=encodeURI(e),t=encodeURI(t);for(var a,r=document.location.search.substr(1).split("&"),i=!0,n=r.length;n--;)(a=r[n].split("="))[0]==e&&(a[1]=t,r[n]=a.join("="),i=!1),"page"==a[0]&&(a[1]=1,r[n]=a.join("="));return i&&(r[r.length]=[e,t].join("=")),r.join("&")}function reviewsRequestSortOption(){return document.URL.match(/rwsortby=([^&]+)/)}function reviewsRequestFilterOption(){return document.URL.match(/rwfilterby=([^&]+)/)}function queryAndRenderReviews(e,t,a,r){function i(e){var t=new Date(e);return t.setMinutes(t.getMinutes()-t.getTimezoneOffset()),t}function n(e,t){return(i(t=t||new Date)-i(e))/864e5}$.ajax({url:e,method:"GET",success:function(e){(function(e){for(var t=e.length-1;t>=0;t--){var a=e[t];a.lastname=a.lastname||"",a.name=a.firstname+" "+a.lastname.charAt(0),a.height&&(a.height=a.height.replace(".","'").replace(" ","'"));var r=parseInt(n(a.created_at));a.date=r>0?r+" days ago":"less than 24 hours ago"}})(e=(e=JSON.parse(e)).map(function(e){return e.published=e.published?"":"disabled-link",e&&!e.rwImgUrl&&(e.noReviewImage="no-review-img"),e})),a&&$("#product-review-page-container").html(""),renderTemplateWithData(t,"#product-review-page-container",e),$(".rw-row input").each(function(e,t){$(t).bootstrapSlider({enabled:!1})}),$(".disabled-link").on("click",!1),r&&r(e)}})}function renderTemplateWithData(e,t,a){var r=getTemplateById(e);$(t).append(a.map(function(e){return r.map(function(t,a){return a%2?e[t]:t}).join("")}))}function getTemplateById(e){return $(e).text().split(/\$\{(.+?)\}/g)}function getURLParamValue(e){var t=new RegExp(e+"=([^&]+)"),a=document.URL.match(t);return a&&a.length>1?a[1]:""}function shouldShowReviewModal(){return!!document.URL.match(/show-review=true/)}function showReviewModal(e){e?($("#rw-modal-container").fadeIn(300),$("#rw-modal-outer").fadeIn(300),$("html, body").animate({scrollTop:0},"slow")):($("#rw-modal-container").fadeOut(300),$("#rw-modal-outer").fadeOut(300))}$(function(){$(function(e,t,a){if(reviewsImageAndSharing=function(r){var i={},n=function(e){e?($("#rw-img-modal-container").fadeIn(500),$("#rw-img-modal-outer").fadeIn(500),$("html, body").animate({scrollTop:0},"slow")):($("#rw-img-modal-container").fadeOut(500),$("#rw-img-modal-outer").fadeOut(500))},o=function(e,t){if(t||(t={}),e){if(t.length<=0)return void logger("data is missing for facebook sharing modal");$("#share > a").on("click",function(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),l(t)}),$("#tw-modal-container").fadeIn(500),$("#tw-modal-outer").fadeIn(500)}else $("#tw-modal-container").fadeOut(500),$("#tw-modal-outer").fadeOut(500)},l=function(e){FB.ui({method:"share_open_graph",mobile_iframe:!0,action_type:"og.shares",action_properties:JSON.stringify({object:{"og:url":e.link,"og:title":e.title,"og:description":e.description,"og:image":e.image}})},function(e){o(!1)})},s=function(e,t){var a=t.app+"add-review-image?shop="+t.shop+"&reviewId="+t.reviewId,r=$(this);$(".btn-img-upload",r);$(".uploader *").hide(),$("#uploadedImage").hide(),$("#loadingMsj").show(),$.ajax({type:"post",url:a,data:e,timeout:8e3,success:function(e,a,r){var l=a.imgUrl||e.imgUrl;return l?(i.image=l,$(".uploader img").attr("src",l)):(logger("error getting image url after uploading"),i.image=t.productImage,$(".uploader img").attr("src","")),n(!1),o(!0,i),!0}.bind(this,t),error:function(e,a,r){logger("error submiting the image review"),n(!1),i.image=t.productImage,o(!0,i)},complete:function(){$("#loadingMsj").hide()}})};return{init:function(r){var l,d=e.getElementsByTagName(t)[0];if(e.getElementById(a)?logger("failed to load facebook sdk"):((l=e.createElement(t)).id=a,l.src="//connect.facebook.net/en_GB/all.js",d.parentNode.insertBefore(l,d)),$("#reviews-container").length<=0)logger("reviews container doesn't exist");else{var u,c,g=$("#reviews-container").data();g.app&&g.bodyname&&g.facebookAppId&&g.shop?(window.fbAsyncInit=function(){FB.init({appId:g.facebookAppId,xfbml:!0,version:"v2.12"})},g.reviewId=r,g.productImage=$('meta[property="og:image"]').attr("content"),function(e){$(".tw-modal-outer").click(function(){$("#tw-modal-container").fadeOut(500),$("#tw-modal-outer").fadeOut(500)}),$("#filePhoto").on("change",function(){var e=new FileReader;e.onload=function(e){e.target.result&&$(".uploader img").attr("src",e.target.result)},e.readAsDataURL(event.target.files[0]),$(".btn-img-upload").removeClass("disable"),$(".img-icon").removeClass("visible")}),$("#rw-img-modal-container #cancel").on("click",function(){n(!1),e.imageToShare=e.productImage,i.length<=0?logger("error getting facebook data"):(i.image=e.imageToShare,o(!0,i))}.bind(this,e,i)),$("#imgReviewUpload").submit(function(){return event.preventDefault(),!1}),$(".btn-img-upload").click(function(){var t=$("#uploadedImage").attr("src"),a=$("input[name='review_image']")[0].files[0];if(a){var r={name:a.name,size:a.size,type:a.type,imgBase64:t};s(r,e)}else logger("error loading image for review")}.bind(this,e))}(g),c=(u=g).app+"get-reviews?shop="+u.shop+"&reviewID="+u.reviewId,$.ajax({async:!1,type:"get",url:c,success:function(e,t,a){i={description:e.title,title:e.fit,link:"https://"+window.location.hostname+window.location.pathname+"?reviewId="+u.reviewId},n(!0)},error:function(e,t,a){logger("error getting the data of review")}})):logger("missing data: ",g)}}}},document.URL.match(/reviewId=/)&&!document.URL.match(/fb_action_types=/)){logger("reviewing from email");var r=(i=new RegExp("reviewId"+"=([^&]+)"),((n=document.URL.match(i))&&n.length>1?n[1]:"")||$("body").data("reviewId"));reviewsImageAndSharing().init(r)}var i,n}(document,"script","facebook-jssdk"))}),$(function(){var e=$("#reviews-container");if(!(e.length<=0)){var t=e.data();t.shop=t.shop.toLowerCase(),t.url=t.app;var a=0,r={reviewsRendered:0,inProgress:!1,stopAll:!1,shouldDeny:function(){return this.stopAll||this.inProgress},start:function(){return function(e){a=a+1||1;var t=e.url+"get-reviews-and-backfills?shop="+e.shop+"&pid="+e.pid+"&bodyName="+e.bodyname+"&limit="+e.limit+"&page="+a;$.ajax({url:t,method:"GET",success:function(e){if(e.reviews.length>0&&(o(e.reviews,"#productReviews"),$("body").addClass("has-reviews"),r.performed()),r.reviewsRendered+=e.reviews.length,r.reviewsRendered==e.reviewsCount&&e.reviewsCount>=5)r.end();else{e.backfills.length>0&&e.reviewsCount<5&&(o(e.backfills,"#backfillReviews"),$("body").addClass("has-backfills"),r.performed()),0==e.reviews.length&&e.reviewsCount>=5&&r.end(),0==e.reviews.length&&0==e.backfills.length&&r.end(),1!=a||e.reviews.length>0||e.backfills.length>0||r.noResults();var t=e.reviewsCount+e.backfillsCount;$(".rw-row").length>=t&&r.end()}}})}(t),this.inProgress=!0},performed:function(){this.inProgress=!1,$("body").trigger("ReviewsLoaded"),$("#loadMoreReviews").show()},noResults:function(){this.stopAll=!0,$("body").addClass("has-no-reviews"),$("body").trigger("HasNoReviews")},end:function(){this.stopAll=!0,$("#loadMoreReviews").hide(),$("body").addClass("all-reviews-fetched"),$("body").trigger("AllReviewsFetched")}};r.start(),$("#loadMoreReviews").on("click",function(){$("#loadMoreReviews").hide(),r.shouldDeny()||r.start()});var i=t.url+"get-average-data?shop="+t.shop+"&pid="+t.pid+"&bodyName="+t.bodyname+"&overallRating=true";$.ajax({url:i,method:"GET",success:function(e){if(e.start_rating){var t={rating:e.start_rating%1!=0?e.start_rating-e.start_rating%1+" half specific":e.start_rating,count:e.reviews_count},a=".reviews-rating-"+e.pid;$(a).each(function(e,a){renderTemplateWithData("#start-rating-template",a,[t])}),$("body").addClass("has-star-rating")}if(e.start_rating_general){t={rating:e.start_rating_general%1!=0?e.start_rating_general-e.start_rating_general%1+" half general":e.start_rating_general,count:e.reviews_count_general},a=".reviews-rating-"+e.pid;$(a).each(function(e,a){renderTemplateWithData("#start-rating-template",a,[t])}),$("body").addClass("has-star-rating")}e.body_fit&&(renderTemplateWithData("#average-fit-template","#overall-fit-body-rating",[0]),$("#overall-fit-body-rating").find("input").bootstrapSlider({enabled:!1,value:e.body_fit}),$("body").addClass("has-body-fit"))}})}function n(e,t){t||(t=new Date);var a=Math.abs(t.getTime()-e.getTime());return Math.ceil(a/864e5)}function o(e,t){e.forEach(function(e){e&&!e.rwImgUrl&&(e.noReviewImage="no-review-img");var t=new Date(e.created_at);e.formatedDate=t.toLocaleString("en-us",{month:"long",day:"numeric",year:"numeric"})}),function(e){for(var t=e.length-1;t>=0;t--){var a=e[t];a.lastname=a.lastname||"",a.name=a.firstname+" "+a.lastname.charAt(0),a.height&&(a.height=a.height.replace(".","'").replace(" ","'"));var r=parseInt(n(new Date(a.created_at)));a.date=r>0?r+" days ago":"less than 24 hours ago"}}(e),renderTemplateWithData("#rw-single-template",t,e),$(".review-information input").each(function(e,t){$(t).hasClass("slided")||($(t).addClass("slided"),$(t).bootstrapSlider({enabled:!1}))})}}),$(function(){function e(e,t){var a=e.body_fit||3;e.start_rating&&renderTemplateWithData("#start-rating-template","#overall-fit-bodyName",[{rating:e.start_rating%1!=0?e.start_rating-e.start_rating%1+" half":e.start_rating,count:e.reviews_count}]);renderTemplateWithData("#average-fit-template","#overall-fit-bodyName",[a]),t.find("input").bootstrapSlider({enabled:!1,value:a}),t.show()}var t=$("#product-review-page-container"),a=t.data("shop"),r=t.data("app");if(a&&r&&0!=t.length){a=a.toLowerCase(),$("#review-filter #rw-filter-by").on("change",function(){var t=this.value,i=$("#overall-fit-bodyName");if(i.empty(),""!=t){var n=CustomLocalStorage.load("fitData["+t+"]");if(n)e(n,i);else{var o=r+"get-average-data?shop="+a+"&bodyName="+t+"&overallRating=true";$.ajax({url:o,method:"GET",success:function(a){e(a,i),CustomLocalStorage.save("fitData["+t+"]",a,12)}})}}}),clearReviewfilters("#review-sorter #rw-sort-by","rwsortby",r);var i="#rw-product-page-template",n=reviewsRequestSortOption();n=n&&n.length>1?n[1]:"latest";var o=reviewsRequestFilterOption();o=o&&o.length>1?o[1]:"";var l=r+"get-bodynames?shop="+a,s=r+"get-reviews?shop="+a+"&rwsortby="+n+"&rwfilterby="+o;$.ajax({url:l,method:"GET",success:function(e){e=JSON.parse(e);var t=$("#review-filter #rw-filter-by");e.map(function(e){var a=' <option value="'+e.bodyName+'">'+e.bodyName+"</option>";t.append(a)}),clearReviewfilters("#review-filter #rw-filter-by","rwfilterby",r)}});var d=function(e){if($(window).scrollTop()>=.85*($(document).height()-$(window).height())){var t=$("#rw-page").val();if(t<=0)return;window.removeEventListener("scroll",d);var n=$("#review-sorter #rw-sort-by").val(),o=$("#review-filter #rw-filter-by").val();queryAndRenderReviews(r+"get-reviews?shop="+a+"&rwsortby="+n+"&rwfilterby="+o+"&page="+t,i,!1,function(e){e.length>0?$("#rw-page").val(parseInt(t)+1):$("#rw-page").val(0),window.addEventListener("scroll",d)})}};queryAndRenderReviews(s,i,!1,function(e){e.length>0&&(window.addEventListener("scroll",d),$("#rw-page").val(2))})}}),$(function(){getURLParamValue("reviewId")||$("body").data("reviewId");var e=$("#rw-modal-container"),t=$("#rw-modal-outer"),a=$("input[name='height']"),r=$("select#rw-ft"),i=$("select#rw-in"),n=e.data("app"),o=e.data("shop");function l(e){if(!e || !(Object.keys(e).length<=0)){var t=e.height.replace('"',"").split("."),a=t[0]||4,n=t[1]||0;$("input[name='firstname']").val(e.first_name),$("input[name='lastname']").val(e.last_name.substring(0,1)),$("input[name='city']").val(e.city),$("input[name='state']").val(e.state),$("input[name='email']").val(e.email),r.val(a),i.val(n);var o=$(".form-submit button");"CONTINUE"==o.html()&&o.html("SUBMIT")}}if(i.on("change",u),r.on("change",u),t.on("click",function(){showReviewModal(!1)}),$("#tw-modal-outer").on("click",function(){$("#tw-modal-container").fadeOut(500),$("#tw-modal-outer").fadeOut(500)}),$(".custumer-email input[name=email]").on("validation",function(e,t){if($(this).hasClass("token"))$(this).removeClass("token");else if(t){var a=n+"get-customers?shop="+o+"&email="+this.value;$.ajax({url:a,method:"GET",success:l})}}),$(".rw-form").submit(function(e){e.preventDefault();showReviewModal(false);$(this).serializeArray().reduce(function(e,t){return e[t.name]=t.value,e},{});var t=$("#product-review-page-container").data("shop"),a=$(this).serialize();a+="&pUrl="+location.pathname;var r=n+"new-review?shop="+t;$.ajax({type:"post",url:r,data:a,success:function(e,t,a){if(e.review_id){var r=e.review_id;$("body").data("reviewId",r);$("#reviews-container").data("app");showReviewModal(!1),reviewsImageAndSharing().init(r)}},error:function(e,t,a){console.log(e,t,a)}})}),$(".grid.product-single").length>0&&shouldShowReviewModal()){showReviewModal(!0);var s=getURLParamValue("token");if(s.length>0){var d=n+"get-customers?shop="+o+"&token="+s;$.ajax({url:d,method:"GET",success:l}).done(function(){$("input[name='email']").addClass("token"),$("input[name='email']").validate()})}!function(){var e={rate:getURLParamValue("rate"),fit:getURLParamValue("fit"),size:getURLParamValue("size"),title:getURLParamValue("title"),rw:getURLParamValue("rw"),email:getURLParamValue("email")};e.rate.length>0&&$("input[value='"+e.rate+"'][name='starRating']").attr("checked",!0);e.fit.length>0&&$("input[name='overallFit']").slider("setValue",e.fit);e.size.length>0&&$("select[name='sizeOrdered']").val(e.size);e.title.length>0&&$('input[name="title"]').val(e.title.replace(/%20/g," "));e.rw.length>0&&$('textarea[name="fit"]').val(e.rw.replace(/%20/g," "));e.email.length>0&&$('input[name="email"]').val(e.email).change().focus()}()}function u(){var e=(""==r.val()?0:r.val())+"."+i.val()+'"';a.val(e)}$.validate({lang:"en"})});var logger=function(e){$("body").data("debug")?alert(e):console.log(e)},CustomLocalStorage={save:function(e,t,a){if("undefined"==typeof Storage)return!1;var r=60*a*1e3*60,i={value:JSON.stringify(t),timestamp:(new Date).getTime()+r};return localStorage.setItem(e,JSON.stringify(i)),t},load:function(e){if("undefined"==typeof Storage)return!1;var t=JSON.parse(localStorage.getItem(e));return t&&(new Date).getTime()<t.timestamp&&JSON.parse(t.value)}};